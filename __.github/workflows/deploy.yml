# Workflow de d√©ploiement am√©lior√© pour Flask Portfolio sur Cloud Run
# Inclut : validation, build optimis√©, d√©ploiement avec rollback, smoke tests, monitoring

name: Deploy to Cloud Run

on:
  push:
    branches: [main]
    paths:
      - 'app/**'
      - 'app/Dockerfile'
      - 'app/requirements.txt'
      - 'app/src/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID || 'bq-small-corp' }}
  SERVICE_NAME: flask-portfolio
  REGION: ${{ vars.GCP_REGION || 'europe-west1' }}
  AR_REPO: flask-portfolio
  IMAGE_NAME: ${{ vars.GCP_REGION || 'europe-west1' }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID || 'bq-small-corp' }}/flask-portfolio/flask-portfolio

permissions:
  contents: read
  id-token: write

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate Dockerfile
        run: |
          docker run --rm -i hadolint/hadolint < app/Dockerfile || echo "‚ö†Ô∏è Dockerfile linting issues"
        continue-on-error: true
      
      - name: Check required files
        run: |
          for file in app/Dockerfile app/requirements.txt app/src/gunicorn_config.py app/run.py app/src/__init__.py; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Missing required file: $file"
              exit 1
            fi
          done
          echo "‚úÖ All required files present"

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 30
    
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          install_components: 'gke-gcloud-auth-plugin'
      
      - name: Verify GCP authentication
        run: |
          echo "üîç Verifying GCP configuration..."
          gcloud config get-value project
          gcloud auth list
          echo "‚úÖ GCP authentication verified"
      
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet
      
      - name: Calculate image tags
        id: image-tags
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          BRANCH_NAME=${BRANCH_NAME//\//-}
          
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "branch=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "‚úÖ Image tags calculated: ${SHORT_SHA}, ${BRANCH_NAME}"
      
      - name: Build Docker image with cache
        uses: docker/build-push-action@v5
        with:
          context: ./app
          file: ./app/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.image-tags.outputs.short_sha }}
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ steps.image-tags.outputs.branch }}
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:latest
          cache-to: type=registry,ref=${{ env.IMAGE_NAME }}:latest,mode=max
          platforms: linux/amd64
          build-args: |
            BUILDKIT_INLINE_CACHE=1
      
      - name: Scan image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ steps.image-tags.outputs.short_sha }}
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true
      
      - name: Get secrets from Secret Manager
        id: secrets
        run: |
          SECRETS_LIST=""
          
          # Secrets requis
          REQUIRED_SECRETS=("SECRET_KEY" "JWT_SECRET_KEY" "DATABASE_URL")
          for secret in "${REQUIRED_SECRETS[@]}"; do
            if gcloud secrets describe ${secret} --project=${{ env.PROJECT_ID }} >/dev/null 2>&1; then
              if [ -z "$SECRETS_LIST" ]; then
                SECRETS_LIST="${secret}=${secret}:latest"
              else
                SECRETS_LIST="${SECRETS_LIST},${secret}=${secret}:latest"
              fi
              echo "‚úÖ Found secret: ${secret}"
            else
              echo "‚ö†Ô∏è Secret not found: ${secret}"
            fi
          done
          
          # Secrets optionnels
          OPTIONAL_SECRETS=("GEMINI_API_KEY" "OPENAI_API_KEY" "REDIS_URL" "SMTP_PASSWORD")
          for secret in "${OPTIONAL_SECRETS[@]}"; do
            if gcloud secrets describe ${secret} --project=${{ env.PROJECT_ID }} >/dev/null 2>&1; then
              SECRETS_LIST="${SECRETS_LIST},${secret}=${secret}:latest"
              echo "‚úÖ Found optional secret: ${secret}"
            fi
          done
          
          echo "secrets_list=${SECRETS_LIST}" >> $GITHUB_OUTPUT
          echo "üìã Secrets to mount: ${SECRETS_LIST}"
      
      - name: Get runtime service account
        id: runtime-sa
        run: |
          RUNTIME_SA_NAME="cr-${SERVICE_NAME}"
          RUNTIME_SA_EMAIL="${RUNTIME_SA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com"
          
          # V√©rifier si le SA existe
          if gcloud iam service-accounts describe ${RUNTIME_SA_EMAIL} --project=${PROJECT_ID} >/dev/null 2>&1; then
            echo "‚úÖ Runtime SA exists: ${RUNTIME_SA_EMAIL}"
          else
            echo "‚ö†Ô∏è Runtime SA not found, will use default"
            RUNTIME_SA_EMAIL=""
          fi
          
          echo "runtime_sa_email=${RUNTIME_SA_EMAIL}" >> $GITHUB_OUTPUT
      
      - name: Deploy to Cloud Run
        id: deploy
        run: |
          set -e
          
          IMAGE_TAG="${{ env.IMAGE_NAME }}:${{ steps.image-tags.outputs.short_sha }}"
          RUNTIME_SA="${{ steps.runtime-sa.outputs.runtime_sa_email }}"
          SECRETS_LIST="${{ steps.secrets.outputs.secrets_list }}"
          
          echo "üöÄ Deploying to Cloud Run..."
          echo "üì¶ Image: ${IMAGE_TAG}"
          echo "üîê Runtime SA: ${RUNTIME_SA:-default}"
          echo "üîë Secrets: ${SECRETS_LIST}"
          
          # Construire la commande de d√©ploiement
          DEPLOY_CMD="gcloud run deploy ${SERVICE_NAME} \
            --image=\"${IMAGE_TAG}\" \
            --region=${REGION} \
            --platform=managed \
            --allow-unauthenticated \
            --project=${PROJECT_ID} \
            --port=8080 \
            --timeout=300s \
            --cpu=1 \
            --memory=1Gi \
            --min-instances=0 \
            --max-instances=10 \
            --concurrency=80 \
            --set-env-vars=\"FLASK_ENV=production,LOG_LEVEL=INFO,ENVIRONMENT=production\""
          
          # Ajouter le service account si disponible
          if [ -n "${RUNTIME_SA}" ]; then
            DEPLOY_CMD="${DEPLOY_CMD} --service-account=${RUNTIME_SA}"
          fi
          
          # Ajouter les secrets si disponibles
          if [ -n "${SECRETS_LIST}" ]; then
            DEPLOY_CMD="${DEPLOY_CMD} --set-secrets=\"${SECRETS_LIST}\""
          fi
          
          DEPLOY_CMD="${DEPLOY_CMD} --quiet"
          
          eval $DEPLOY_CMD
          
          echo "‚úÖ Deployment successful"
      
      - name: Get service URL
        id: get-url
        run: |
          URL=$(gcloud run services describe ${SERVICE_NAME} \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --format='value(status.url)')
          
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "üåê Service URL: ${URL}"
      
      - name: Wait for service to be ready
        id: health-check
        run: |
          URL="${{ steps.get-url.outputs.url }}"
          echo "‚è≥ Waiting for service to be ready..."
          
          MAX_RETRIES=15
          RETRY_COUNT=0
          INITIAL_DELAY=5
          MAX_DELAY=60
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            DELAY=$((INITIAL_DELAY * (1 << RETRY_COUNT)))
            if [ $DELAY -gt $MAX_DELAY ]; then
              DELAY=$MAX_DELAY
            fi
            
            if curl -f -s --max-time 10 "${URL}/health" >/dev/null 2>&1; then
              echo "‚úÖ Health check passed!"
              echo "healthy=true" >> $GITHUB_OUTPUT
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT+1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚è≥ Health check failed, retrying in ${DELAY}s... ($RETRY_COUNT/$MAX_RETRIES)"
                sleep $DELAY
              fi
            fi
          done
          
          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          echo "healthy=false" >> $GITHUB_OUTPUT
          
          # Afficher les logs r√©cents
          echo "üìã Recent logs:"
          gcloud run logs read ${SERVICE_NAME} \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --limit=50 \
            --format="table(timestamp,severity,textPayload)" || true
          
          exit 1
      
      - name: Run smoke tests
        id: smoke-tests
        if: steps.health-check.outputs.healthy == 'true'
        run: |
          URL="${{ steps.get-url.outputs.url }}"
          
          echo "üß™ Running comprehensive smoke tests..."
          
          TESTS_PASSED=0
          TESTS_FAILED=0
          
          # Test 1: Health endpoint
          if curl -f -s --max-time 10 "${URL}/health" >/dev/null 2>&1; then
            echo "‚úÖ Health endpoint test passed"
            TESTS_PASSED=$((TESTS_PASSED+1))
          else
            echo "‚ùå Health endpoint test failed"
            TESTS_FAILED=$((TESTS_FAILED+1))
          fi
          
          # Test 2: Metrics endpoint
          if curl -f -s --max-time 10 "${URL}/metrics" >/dev/null 2>&1; then
            echo "‚úÖ Metrics endpoint test passed"
            TESTS_PASSED=$((TESTS_PASSED+1))
          else
            echo "‚ö†Ô∏è Metrics endpoint test failed (non-critical)"
            TESTS_FAILED=$((TESTS_FAILED+1))
          fi
          
          # Test 3: Homepage
          if curl -f -s --max-time 10 "${URL}/" >/dev/null 2>&1; then
            echo "‚úÖ Homepage test passed"
            TESTS_PASSED=$((TESTS_PASSED+1))
          else
            echo "‚ùå Homepage test failed"
            TESTS_FAILED=$((TESTS_FAILED+1))
          fi
          
          echo ""
          echo "üìä Test Summary: $TESTS_PASSED passed, $TESTS_FAILED failed"
          
          if [ $TESTS_FAILED -gt 1 ]; then
            echo "‚ùå Too many tests failed"
            exit 1
          fi
          
          echo "tests_passed=${TESTS_PASSED}" >> $GITHUB_OUTPUT
          echo "tests_failed=${TESTS_FAILED}" >> $GITHUB_OUTPUT
      
      - name: Rollback on failure
        if: failure() && steps.health-check.outputs.healthy != 'true'
        run: |
          echo "üîÑ Attempting automatic rollback..."
          
          PREVIOUS_REVISION=$(gcloud run revisions list \
            --service=${SERVICE_NAME} \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --format="value(name)" \
            --limit=2 \
            --sort-by=~metadata.creationTimestamp | tail -n 1)
          
          if [ -n "$PREVIOUS_REVISION" ]; then
            echo "üì¶ Rolling back to: ${PREVIOUS_REVISION}"
            gcloud run services update-traffic ${SERVICE_NAME} \
              --to-revisions=${PREVIOUS_REVISION}=100 \
              --region=${REGION} \
              --project=${PROJECT_ID} \
              --quiet
            echo "‚úÖ Rollback completed"
          else
            echo "‚ö†Ô∏è No previous revision found for rollback"
          fi
      
      - name: Cleanup old images
        if: success()
        continue-on-error: true
        run: |
          echo "üßπ Cleaning up old images (keeping last 10)..."
          
          IMAGES=$(gcloud artifacts docker images list \
            ${REGION}-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/${SERVICE_NAME} \
            --project=${PROJECT_ID} \
            --format="value(version)" \
            --sort-by=~CREATE_TIME)
          
          IMAGE_COUNT=$(echo "$IMAGES" | wc -l | tr -d ' ')
          
          if [ "$IMAGE_COUNT" -gt 10 ]; then
            echo "$IMAGES" | tail -n +11 | while read version; do
              echo "üóëÔ∏è Deleting old image: ${version}"
              gcloud artifacts docker images delete \
                ${REGION}-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/${SERVICE_NAME}@${version} \
                --project=${PROJECT_ID} \
                --quiet || true
            done
            echo "‚úÖ Cleanup completed"
          else
            echo "‚ÑπÔ∏è Only $IMAGE_COUNT images found, no cleanup needed"
          fi
      
      - name: Deployment summary
        if: always()
        run: |
          URL="${{ steps.get-url.outputs.url }}"
          IMAGE_TAG="${{ env.IMAGE_NAME }}:${{ steps.image-tags.outputs.short_sha }}"
          HEALTH_STATUS="${{ steps.health-check.outputs.healthy }}"
          TESTS_PASSED="${{ steps.smoke-tests.outputs.tests_passed }}"
          TESTS_FAILED="${{ steps.smoke-tests.outputs.tests_failed }}"
          
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$HEALTH_STATUS" = "true" ]; then
            echo "**Status:** ‚úÖ Success" >> $GITHUB_STEP_SUMMARY
            echo "**Service URL:** ${URL}" >> $GITHUB_STEP_SUMMARY
            echo "**Image:** \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
            echo "**Health Check:** ${URL}/health" >> $GITHUB_STEP_SUMMARY
            echo "**Metrics:** ${URL}/metrics" >> $GITHUB_STEP_SUMMARY
            if [ -n "$TESTS_PASSED" ]; then
              echo "**Smoke Tests:** ‚úÖ $TESTS_PASSED passed, ‚ö†Ô∏è $TESTS_FAILED failed" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ‚ùå Failed" >> $GITHUB_STEP_SUMMARY
            echo "**Image:** \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è Health check failed. Please review the logs." >> $GITHUB_STEP_SUMMARY
          fi

