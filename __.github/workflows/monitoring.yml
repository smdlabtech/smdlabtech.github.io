# Workflow de monitoring et health checks am√©lior√©
# Surveille la sant√© de l'application en production

name: Monitoring Health Checks

on:
  schedule:
    # Ex√©cution toutes les 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID || 'bq-small-corp' }}
  SERVICE_NAME: flask-portfolio
  REGION: ${{ vars.GCP_REGION || 'europe-west1' }}

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get service URL
        id: get-url
        run: |
          # Essayer de r√©cup√©rer l'URL depuis Cloud Run
          URL=$(gcloud run services describe ${SERVICE_NAME} \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --format='value(status.url)' 2>/dev/null || echo "")
          
          if [ -z "$URL" ]; then
            # Fallback: construire l'URL
            URL="https://${SERVICE_NAME}-${REGION}.a.run.app"
          fi
          
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "üåê Service URL: ${URL}"
      
      - name: Health Check
        id: health
        run: |
          URL="${{ steps.get-url.outputs.url }}"
          
          echo "üîç Running health checks..."
          
          # Test 1: Health endpoint
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${URL}/health" || echo "000")
          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "‚úÖ Health endpoint: OK (${HEALTH_STATUS})"
            echo "health_ok=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Health endpoint: FAILED (${HEALTH_STATUS})"
            echo "health_ok=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Test 2: Readiness endpoint
          READY_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${URL}/health/ready" || echo "000")
          if [ "$READY_STATUS" = "200" ]; then
            echo "‚úÖ Readiness endpoint: OK (${READY_STATUS})"
            echo "ready_ok=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Readiness endpoint: FAILED (${READY_STATUS})"
            echo "ready_ok=false" >> $GITHUB_OUTPUT
          fi
          
          # Test 3: Liveness endpoint
          LIVE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${URL}/health/live" || echo "000")
          if [ "$LIVE_STATUS" = "200" ]; then
            echo "‚úÖ Liveness endpoint: OK (${LIVE_STATUS})"
            echo "live_ok=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Liveness endpoint: FAILED (${LIVE_STATUS})"
            echo "live_ok=false" >> $GITHUB_OUTPUT
          fi
          
          # Test 4: Metrics endpoint
          METRICS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${URL}/metrics" || echo "000")
          if [ "$METRICS_STATUS" = "200" ]; then
            echo "‚úÖ Metrics endpoint: OK (${METRICS_STATUS})"
            echo "metrics_ok=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Metrics endpoint: FAILED (${METRICS_STATUS})"
            echo "metrics_ok=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Performance Check
        id: performance
        run: |
          URL="${{ steps.get-url.outputs.url }}"
          
          echo "‚ö° Running performance checks..."
          
          # Mesurer le temps de r√©ponse
          RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" --max-time 10 "${URL}/health" || echo "999")
          
          # Convertir en millisecondes
          RESPONSE_TIME_MS=$(echo "$RESPONSE_TIME * 1000" | bc | cut -d. -f1)
          
          echo "‚è±Ô∏è Response time: ${RESPONSE_TIME_MS}ms"
          echo "response_time=${RESPONSE_TIME_MS}" >> $GITHUB_OUTPUT
          
          # V√©rifier si le temps de r√©ponse est acceptable (< 2s)
          if [ "$RESPONSE_TIME_MS" -lt 2000 ]; then
            echo "‚úÖ Performance: OK"
            echo "performance_ok=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Performance: SLOW (${RESPONSE_TIME_MS}ms > 2000ms)"
            echo "performance_ok=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Get service metrics
        id: metrics
        if: steps.health.outputs.health_ok == 'true'
        run: |
          URL="${{ steps.get-url.outputs.url }}"
          
          echo "üìä Fetching service metrics..."
          
          # R√©cup√©rer les m√©triques Prometheus
          METRICS=$(curl -s --max-time 10 "${URL}/metrics" || echo "")
          
          if [ -n "$METRICS" ]; then
            # Extraire quelques m√©triques cl√©s
            HTTP_REQUESTS=$(echo "$METRICS" | grep 'flask_http_requests_total' | head -1 || echo "")
            ERROR_RATE=$(echo "$METRICS" | grep 'flask_http_errors_total' | head -1 || echo "")
            
            echo "üìà HTTP Requests: ${HTTP_REQUESTS}"
            echo "‚ùå Errors: ${ERROR_RATE}"
          fi
      
      - name: Notify on failure
        if: failure() && secrets.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Health check failed for Flask Portfolio
            Environment: ${{ github.event.inputs.environment || 'production' }}
            Service: ${SERVICE_NAME}
            URL: ${{ steps.get-url.outputs.url }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
      
      - name: Health check summary
        if: always()
        run: |
          echo "## üè• Health Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${SERVICE_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.get-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Health | ${{ steps.health.outputs.health_ok == 'true' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Readiness | ${{ steps.health.outputs.ready_ok == 'true' && '‚úÖ' || '‚ö†Ô∏è' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Liveness | ${{ steps.health.outputs.live_ok == 'true' && '‚úÖ' || '‚ö†Ô∏è' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Metrics | ${{ steps.health.outputs.metrics_ok == 'true' && '‚úÖ' || '‚ö†Ô∏è' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | ${{ steps.performance.outputs.performance_ok == 'true' && '‚úÖ' || '‚ö†Ô∏è' }} (${{ steps.performance.outputs.response_time }}ms) |" >> $GITHUB_STEP_SUMMARY

